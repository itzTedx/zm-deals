import { useEffect, useMemo, useState } from "react";

import NumberFlow from "@number-flow/react";
import { useFormContext } from "react-hook-form";

import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { FormControl, FormDescription, FormField, FormItem, FormLabel, FormMessage } from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import { Separator } from "@/components/ui/separator";
import { Textarea } from "@/components/ui/textarea";

import { IconChevronRight } from "@/assets/icons";

import { useCharacterCount } from "@/hooks/use-character";
import { env } from "@/lib/env/client";
import { slugify } from "@/lib/functions/slugify";
import { cn } from "@/lib/utils";
import { ProductSchema } from "@/modules/product/schema";

export const ProductMeta = () => {
  const form = useFormContext<ProductSchema>();
  const [isSlugManual, setIsSlugManual] = useState(false);

  const metadata = form.watch("meta");
  const currentSlug = form.watch("slug");
  const currentTitle = form.watch("title");

  const titleHook = useCharacterCount({
    maxLength: 70,
    value: metadata?.title,
    onChange: (value) => form.setValue("meta.title", value),
  });

  const descriptionHook = useCharacterCount({
    maxLength: 155,
    value: metadata?.description,
    onChange: (value) => form.setValue("meta.description", value),
  });

  const autoGeneratedSlug = useMemo(() => {
    return slugify(currentTitle ?? "");
  }, [currentTitle]);

  const handleSlugToggle = () => {
    if (isSlugManual) {
      // Switching to auto mode - use auto-generated slug
      form.setValue("slug", autoGeneratedSlug);
      setIsSlugManual(false);
    } else {
      // Switching to manual mode - keep current auto-generated slug as starting point
      form.setValue("slug", autoGeneratedSlug);
      setIsSlugManual(true);
    }
  };

  const handleSlugChange = (value: string) => {
    form.setValue("slug", value);
    // If user manually changes the slug, switch to manual mode
    if (!isSlugManual) {
      setIsSlugManual(true);
    }
  };

  // Watch for changes in main title and update slug in auto mode
  // biome-ignore lint/correctness/useExhaustiveDependencies: no need to re-run this effect when the slug is manually changed
  useEffect(() => {
    if (!isSlugManual && currentTitle) {
      const newSlug = slugify(currentTitle);
      form.setValue("slug", newSlug);
    }
  }, [currentTitle, isSlugManual]);

  return (
    <Card className="col-span-2 p-0.5">
      <CardHeader className="px-4 pt-1.5 pb-1">
        <CardTitle className="text-sm">Seo & Metadata</CardTitle>
      </CardHeader>
      <CardContent className="space-y-6 p-4">
        <div>
          <h3 className="font-medium text-gray-700 text-sm">ZM Deals</h3>
          <span className="flex items-center gap-1 font-medium text-gray-500 text-xs">
            {env.NEXT_PUBLIC_BASE_URL}
            <IconChevronRight /> deals <IconChevronRight />
            {currentSlug || autoGeneratedSlug}
          </span>
          <h4 className="font-medium text-[#005bd3] text-lg">{form.watch("meta.title")}</h4>
          <p className="text-gray-500 text-sm">{form.watch("meta.description")}</p>
        </div>
        <Separator />
        <FormField
          control={form.control}
          name="meta.title"
          render={({ field }) => (
            <FormItem>
              <FormLabel>Page Title</FormLabel>
              <FormControl>
                <Input name={field.name} onBlur={field.onBlur} onChange={titleHook.handleChange} />
              </FormControl>
              <FormDescription className="flex items-center justify-between gap-2">
                <span className={titleHook.isMaxLengthExceeded ? "text-destructive" : "text-gray-600"}>
                  <NumberFlow value={titleHook.characterCount} /> of 70 characters used
                </span>
                {titleHook.statusMessage && (
                  <span
                    className={cn(
                      "tabular-nums",
                      titleHook.isMaxLengthExceeded ? "text-destructive" : "text-yellow-600"
                    )}
                  >
                    {titleHook.statusMessage}
                  </span>
                )}
              </FormDescription>
              <FormMessage />
            </FormItem>
          )}
        />
        <FormField
          control={form.control}
          name="meta.description"
          render={({ field }) => (
            <FormItem>
              <FormLabel>Meta Description</FormLabel>
              <FormControl>
                <Textarea className="min-h-20" {...field} />
              </FormControl>
              <FormDescription className="flex items-center justify-between gap-2">
                <span className={descriptionHook.isMaxLengthExceeded ? "text-destructive" : "text-gray-600"}>
                  <NumberFlow value={descriptionHook.characterCount} /> of 160 characters used
                </span>
                {descriptionHook.statusMessage && (
                  <span
                    className={cn(
                      "tabular-nums",
                      descriptionHook.isMaxLengthExceeded ? "text-destructive" : "text-yellow-600"
                    )}
                  >
                    {descriptionHook.statusMessage}
                  </span>
                )}
              </FormDescription>
              <FormMessage />
            </FormItem>
          )}
        />
        <FormField
          control={form.control}
          name="slug"
          render={({ field }) => (
            <FormItem>
              <FormLabel className="flex items-center justify-between">
                URL Handle
                <Button
                  className="h-auto p-1 text-xs"
                  onClick={handleSlugToggle}
                  size="sm"
                  type="button"
                  variant="ghost"
                >
                  {isSlugManual ? "Auto-generate" : "Manual"}
                </Button>
              </FormLabel>
              <FormControl>
                <div className="relative font-medium">
                  <Input
                    {...field}
                    className="peer ps-[3.25rem]"
                    onChange={(e) => handleSlugChange(e.target.value)}
                    type="text"
                    value={field.value || ""}
                  />
                  <span className="pointer-events-none absolute inset-y-0 start-0 flex items-center justify-center ps-3 text-muted-foreground text-sm peer-disabled:opacity-50">
                    deals/
                  </span>
                </div>
              </FormControl>
              <FormDescription>
                <span>
                  {env.NEXT_PUBLIC_BASE_URL}/deals/{currentSlug || autoGeneratedSlug}
                </span>
                {!isSlugManual && (
                  <span className="mt-1 block text-muted-foreground text-xs">Automatically generated from title</span>
                )}
              </FormDescription>
              <FormMessage />
            </FormItem>
          )}
        />
      </CardContent>
    </Card>
  );
};
